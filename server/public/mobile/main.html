<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Olo联盟</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/style.css">
	</head>

	<body class="mui-fullscreen">
		<!--页面主结构开始-->
		<div id="app" class="mui-views">
			<div class="mui-view">
				<div class="mui-navbar">
				</div>
				<div class="mui-pages">
				</div>
			</div>
		</div>
		<!--页面主结构结束-->
		<!--单页面开始-->
		<div id="main" class="mui-page">
			<!--页面标题栏开始-->
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>登出
				</button>
				<h1 class="mui-center mui-title">Olo联盟</h1>
			</div>
			<!--页面标题栏结束-->
			<!--页面主内容区开始-->
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
                        <div class="title">每日任务</div>
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell">
								<a href="#domission" class="mui-navigate-right">去做任务</a>
							</li>
						</ul>
                        <div id="verify" style="display: none;">
                        <div class="title">任务审核</div>
						<ul class="mui-table-view mui-table-view-chevron" id="groupList">
							<li class="mui-table-view-cell" data-id="{id}">
								<a class="mui-navigate-right">{groupname} <i class="mui-badge mui-badge-danger state{state1}">{state1}</i></a>
							</li>
						</ul>
						</div>
						<ul class="mui-table-view mui-table-view-chevron">
							<li class="mui-table-view-cell">
								<a href="#about" class="mui-navigate-right">关于</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<!--页面主内容区结束-->
		</div>
		<div id="domission" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>首页
				</button>
				<h1 class="mui-center mui-title">我的任务</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
					    <div class="title">任务列表 <span id="missionlogdate"></span></div>
						<ul class="mui-table-view" id="missionList">
							<li class="mui-table-view-cell" data-id="{id}" missionstate="{missionstate}">
								{missionname}
								<span class="mui-navigate-right"></span>
								<span class="missionstate"></span>
							</li>
						</ul>
						<div class="mui-content-padded">
							<p>完成任务后将游戏截图上传至相应任务中并点击“我已完成”，组长将进行审核。</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div id="usermission" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>首页
				</button>
				<h1 class="mui-center mui-title">成员任务</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
					    <div class="title">任务列表 <span id="missionlogdate"></span></div>
						<ul class="mui-table-view" id="missionList">
							<li class="mui-table-view-cell" data-id="{id}" missionstate="{missionstate}">
								{missionname}
								<span class="mui-navigate-right"></span>
								<span class="missionstate"></span>
							</li>
						</ul>
						<div class="mui-content-padded">
							<p>请仔细审核。</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div id="users" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>首页
				</button>
				<h1 class="mui-center mui-title">分组成员</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
					    <div class="title">成员列表 <span id="groupName"></span></div>
						<ul class="mui-table-view" id="userList">
							<li class="mui-table-view-cell" data-id="{id}" missionstate="{state}">
								{nickname} {gameid}
								<span class="mui-navigate-right"></span>
								<span class="missionstate"></span>
							</li>
						</ul>
						<div class="mui-content-padded">
							<p>截图只能保存三天，请尽快审核。</p>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div id="missioninfo" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>我的任务
				</button>
				<h1 class="mui-center mui-title">任务详情</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="mui-content-padded">
                            <h4 field="missionname"></h4>
                            <h5 field="missiondetail"></h5>
                            <div id="screenshotList">
                                <div><img src="" alt=""></div>
                            </div>
                            <button id="chooseImage">上传截图</button>
                            <button id="doneMission">我已完成</button>
                            <button id="passMission">审核通过</button>
                            <button id="backMission">不通过</button>
                            <div id="missionState"></div>
                            <div>注意：截图只能保存3天，超过3天将无法显示。 </div>
                        </div>
					</div>
				</div>
			</div>
		</div>
		
		<div id="about" class="mui-page">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>首页
				</button>
				<h1 class="mui-center mui-title">关于</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<div class="mui-content-padded">
                            <h4 style="margin-top:10px;">作者：完美小盒子</h4>
                            <div id="currnet" style="padding: 1em;font-size: 12px;"></div>
                        </div>
					</div>
				</div>
			</div>
		</div>

		<div id="feedback" class="mui-page feedback">
			<div class="mui-navbar-inner mui-bar mui-bar-nav">
				<button type="button" class="mui-left mui-action-back mui-btn  mui-btn-link mui-btn-nav mui-pull-left">
					<span class="mui-icon mui-icon-left-nav"></span>关于MUI
				</button>
				<button id="submit" class="mui-btn mui-btn-blue mui-btn-link mui-pull-right">发送</button>
				<h1 class="mui-center mui-title">问题反馈</h1>
			</div>
			<div class="mui-page-content">
				<div class="mui-content-padded">
					<div class="mui-inline">问题和意见</div>
					<a class="mui-pull-right mui-inline" href="#popover">
						快捷输入
						<span class="mui-icon mui-icon-arrowdown"></span>
					</a>
					<!--快捷输入具体内容，开发者可自己替换常用语-->
					<div id="popover" class="mui-popover">
						<div class="mui-popover-arrow"></div>
						<div class="mui-scroll-wrapper">
							<div class="mui-scroll">
								<ul class="mui-table-view">
									<!--仅流应用环境下显示-->
									<li class="mui-table-view-cell stream">
										<a href="#">桌面快捷方式创建失败</a>
									</li>
									<li class="mui-table-view-cell"><a href="#">界面显示错乱</a></li>
									<li class="mui-table-view-cell"><a href="#">启动缓慢，卡出翔了</a></li>
									<li class="mui-table-view-cell"><a href="#">偶发性崩溃</a></li>
									<li class="mui-table-view-cell"><a href="#">UI无法直视，丑哭了</a></li>
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="row mui-input-row">
					<textarea id='question' class="mui-input-clear question" placeholder="请详细描述你的问题和意见..."></textarea>
				</div>
				<p>图片(选填,提供问题截图,总大小10M以下)</p>
				<div id='image-list' class="row image-list"></div>
				<p>QQ/邮箱</p>
				<div class="mui-input-row">
					<input id='contact' type="text" class="mui-input-clear contact" placeholder="(选填,方便我们联系你 )" />
				</div>
				<div class="mui-content-padded">
					<div class="mui-inline">应用评分</div>
					<div class="icons mui-inline" style="margin-left: 6px;">
						<i data-index="1" class="mui-icon mui-icon-star"></i>
						<i data-index="2" class="mui-icon mui-icon-star"></i>
						<i data-index="3" class="mui-icon mui-icon-star"></i>
						<i data-index="4" class="mui-icon mui-icon-star"></i>
						<i data-index="5" class="mui-icon mui-icon-star"></i>
					</div>
				</div><br />
			</div>
		</div>
<div id="ProgressBar"><div class="progressBarCon"><p class="progressBarDes">正在重启...</p><div class="progressBarBg"><p class="progressBarDe">0%</p></div><p class="progressBarDone">注意：重启完成之后，该页面会自动跳转。如果长时间未自动跳转，请检查您的电脑与路由器之间的连接是否正常。</p></div></div>
	</body>
	<script src="js/mui.min.js "></script>
	<script src="js/mui.view.js "></script>
	<script type="text/javascript" src="../js/jquery-1.11.2.min.js"></script>
    <script type="text/javascript" src="../js/pending.js"></script>
    <script type="text/javascript" src="../js/storage.js"></script>
    <script type="text/javascript" src="../js/common.js"></script>
    <script type="text/javascript" src="../js/api.js"></script>
    <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	<script>
		mui.init();
		//初始化单页view
		var viewApi = mui('#app').view({
			defaultPage: '#main'
		});
		//初始化单页的区域滚动
		mui('.mui-scroll-wrapper').scroll();
		
		var view = viewApi.view;
		(function() {
            
            var missionTemplate = $('#missionList').html();
            var groupTemplate = $('#groupList').html();
            var userTemplate = $('#userList').html();
            $('#missionList').html('');
            $('#groupTemplate').html('');
            $('#userTemplate').html('');
            var current = {};
            var missionMap = new Map();
            var groupMap = new Map();
            var userMap = new Map();
            
			//处理view的后退与webview后退
			var oldBack = mui.back;
			mui.back = function() {
				if (viewApi.canBack()) { //如果view可以后退，则执行view的后退
					viewApi.back();
				} else { //执行webview后退
					oldBack();
				}
			};
			//监听页面切换事件方案1,通过view元素监听所有页面切换事件，目前提供pageBeforeShow|pageShow|pageBeforeBack|pageBack四种事件(before事件为动画开始前触发)
			//第一个参数为事件名称，第二个参数为事件回调，其中e.detail.page为当前页面的html对象
			view.addEventListener('pageBeforeShow', function(e) {
                var pageid = e.detail.page.id;
                if(pageid == 'main'){
                    loadLeaderGroup();
                }
                if(pageid == 'domission'){
                    loadMyMissions();
                }
                if(pageid == 'usermission'){
                    loadMissions();
                }
                if(pageid == 'users'){
                    loadGroupMembers();
                }
                if(pageid == 'missioninfo'){
                    loadMissionLog();
                }
			});
			view.addEventListener('pageShow', function(e) {
								console.log(e.detail.page.id + ' show');
			});
			view.addEventListener('pageBeforeBack', function(e) {
				//				console.log(e.detail.page.id + ' beforeBack');
			});
			view.addEventListener('pageBack', function(e) {
				//				console.log(e.detail.page.id + ' back');
			});
            loadLeaderGroup();
            
            
            mui('#domission').on('tap','li.mui-table-view-cell',function(){
                var id = $(this).attr('data-id');
                current.mission = missionMap.get(id);
                current.user = null;
                viewApi.go('#missioninfo');
                $('#missioninfo .mui-scroll').css('transform','');
            });
            
            mui('#usermission').on('tap','li.mui-table-view-cell',function(){
                var id = $(this).attr('data-id');
                current.mission = missionMap.get(id);
                viewApi.go('#missioninfo');
                $('#missioninfo .mui-scroll').css('transform','');
            });
            
            mui('#groupList').on('tap','li.mui-table-view-cell',function(){
                var id = $(this).attr('data-id');
                current.group = groupMap.get(id);
                viewApi.go('#users');
            });
            mui('#users').on('tap','li.mui-table-view-cell',function(){
                var id = $(this).attr('data-id');
                current.user = userMap.get(id);
                viewApi.go('#usermission');
                
            });
            
            var serverIds;
            mui('#missioninfo').on('tap','#chooseImage',function(){
                serverIds = [];
                wx.chooseImage({
                    count: 9, // 默认9
                    sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType: ['album'], // 可以指定来源是相册还是相机，默认二者都有
                    success: function (res) {
                        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                        var html = '';
                        localIds.forEach(function(img,index){
                            html += '<div><img src="'+img+'" /></div>';
                        });
                        $('#screenshotList').append(html);
                        
                        var uploadImages = function(inlist,outlist,callback){
                            var localId = inlist.shift();
                            wx.uploadImage({
                                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                                isShowProgressTips: 1, // 默认为1，显示进度提示
                                success: function (res) {
                                    var serverId = res.serverId; // 返回图片的服务器端ID
                                    outlist.push(serverId);
                                    
                                    if(0 == localIds.length){
                                        callback();
                                    }else{
                                        uploadImages(inlist,outlist,callback);
                                    }
                                }
                            });
                        }
                        uploadImages(localIds,serverIds,function(){
                            api_mission_addSrceenShots({imageids:serverIds.join(','),missionid:current.mission.id,missionlogid:current.missionlog.id},function(){
                                mui.toast(serverIds.length+'张截图已上传完成');
                                $('#doneMission').show();
                            });
                        });
                    }
                });
            });
            
            mui('#missioninfo').on('tap','#doneMission',function(){
                api_mission_changeMissionLogState({missionlogid:current.missionlog.id,state:1},function(){
                    loadMissionLog();
                });
            });
            
            mui('#missioninfo').on('tap','#passMission',function(){
                api_mission_changeMissionLogState({missionlogid:current.missionlog.id,state:2},function(){
                    loadMissionLog();
                });
            });
            
            mui('#missioninfo').on('tap','#backMission',function(){
                api_mission_changeMissionLogState({missionlogid:current.missionlog.id,state:0},function(){
                    loadMissionLog();
                });
            });
            
            function loadLeaderGroup(){
                api_group_getLeaderGroups(function(data){
                    var list = data;
                    var html = '';
                    if(list && list.length){
                       list.forEach(function(group){
                            html += groupTemplate.toObject(group);
                            groupMap.set(group.id+"",group);
                        });
                        $('#groupList').html(html).show();
                        $('#verify').show();
                    }else{
                        $('#verify').hide();
                    }
                    
                });
            }
            function loadGroupMembers(){
                api_group_getGroupMembers({groupid:current.group.id},function(data){
                    var list = data;
                    var html = '';
                    list.forEach(function(user){
                        html += userTemplate.toObject(user);
                        userMap.set(user.id+"",user);
                    });
                    $('#userList').html(html).show();
                });
            }
            function loadMissions(){
                api_mission_getMissions({userid:current.user.id},function(list){
                    if(list && list.length){
                        var html = '';
                        list.forEach(function(mission){
                            html += missionTemplate.toObject(mission);
                            missionMap.set(mission.id+"",mission);
                        });
                        $('#usermission #missionList').html(html);
                    }

                });
            }
            function loadMyMissions(){
                api_mission_getMyMissions(function(list){
                    if(list && list.length){
                        var html = '';
                        list.forEach(function(mission){
                            html += missionTemplate.toObject(mission);
                            missionMap.set(mission.id+"",mission);
                        });
                        $('#domission #missionList').html(html);

                        $('#missionlogdate').text(new Date(list[0].missionlogdate).Format('yyyy-MM-dd'));
                    }

                });
            }
            function loadMissionLog(){
                $('#screenshotList').html('');
                $('#chooseImage').hide();
                $('#doneMission').hide();
                $('#passMission').hide();
                $('#backMission').hide();
                $('#missionState').hide();

                var para = {
                    missionid:current.mission.id
                }
                if(current.user){
                    para.userid = current.user.id;
                }
                api_mission_getMissionLog(para,function(data){
                    current.missionlog = data.missionlog;
                    setField(data.mission,$('#missioninfo'));
                    var list = data.srceenshots;
                    var html = '';
                    var downloadImages = function(inlist,outlist,callback){
                        var imageid = inlist.shift();
                        wx.downloadImage({
                            serverId: imageid, // 需要下载的图片的服务器端ID，由uploadImage接口获得
                            isShowProgressTips: 1, // 默认为1，显示进度提示
                            success: function (res) {
                                var localId = res.localId; // 返回图片下载后的本地ID
                                outlist.push(localId);

                                if(inlist.length == 0){
                                    callback();
                                }else{
                                    downloadImages(inlist,outlist,callback);
                                }
                            }
                        });
                    }
                    if(list && list.length){
                        var inlist = [],outlist = [];
                        list.forEach(function(ss){
                            inlist.push(ss.imageid);
                        });
                        downloadImages(inlist,outlist,function(){
                            outlist.forEach(function(img){
                                html += '<div><img src="'+img+'" /></div>';
                            });
                            $('#screenshotList').html(html);
                        });
                    }
                    
                    $('#missionState').removeAttr('class').addClass('missionstate'+current.missionlog.missionstate).show();
                    if(current.missionlog.isowner){
                        switch(current.missionlog.missionstate){
                            case 0:
                                $('#chooseImage').show();
                                $('#doneMission').show();
                                break;
                        }
                    }
                    if(current.missionlog.isleader){
                        switch(current.missionlog.missionstate){
                            case 0:
                                break;
                            case 1:
                                $('#passMission').show();
                                $('#backMission').show();
                                break;
                            case 2:
                                break;
                        }
                    }
                });
            }
		})();
        Box = {
            alert:function(msg,title,config){
                mui.alert(msg,title,null,config.ok);
            }
        }
      getSignature();
	</script>

</html>